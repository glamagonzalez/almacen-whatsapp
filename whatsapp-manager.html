<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Manager - Evolution API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #128C7E 0%, #075E54 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #qrcode img {
            max-width: 100%;
            border: 10px solid white;
            border-radius: 20px;
        }
        .status-badge {
            font-size: 1.2rem;
            padding: 10px 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white text-center">
                        <h3>üì± WhatsApp Manager</h3>
                        <p class="mb-0">Evolution API + n8n Integration</p>
                    </div>
                    <div class="card-body">
                        <!-- Status -->
                        <div class="text-center mb-4">
                            <h5>Estado de Conexi√≥n:</h5>
                            <span id="status" class="badge status-badge bg-secondary">Verificando...</span>
                        </div>

                        <!-- Tabs -->
                        <ul class="nav nav-tabs mb-4" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="connect-tab" data-bs-toggle="tab" data-bs-target="#connect" type="button">
                                    üîå Conectar WhatsApp
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="test-tab" data-bs-toggle="tab" data-bs-target="#test" type="button">
                                    ‚úâÔ∏è Enviar Mensaje
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button">
                                    ‚ÑπÔ∏è Informaci√≥n
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content">
                            <!-- Conectar WhatsApp -->
                            <div class="tab-pane fade show active" id="connect">
                                <div class="text-center">
                                    <button id="btnGenerate" class="btn btn-success btn-lg mb-3" onclick="generateQR()">
                                        üì± Generar QR Code
                                    </button>
                                    <div id="qrcode"></div>
                                    <div id="instructions" style="display:none;" class="alert alert-info mt-3">
                                        <h5>üìã Instrucciones:</h5>
                                        <ol class="text-start">
                                            <li>Abre WhatsApp en tu celular</li>
                                            <li>Ve a <strong>Configuraci√≥n</strong> ‚Üí <strong>Dispositivos vinculados</strong></li>
                                            <li>Toca <strong>Vincular dispositivo</strong></li>
                                            <li>Escanea este c√≥digo QR</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>

                            <!-- Enviar Mensaje -->
                            <div class="tab-pane fade" id="test">
                                <form onsubmit="sendMessage(event)">
                                    <div class="mb-3">
                                        <label class="form-label">N√∫mero de tel√©fono (con c√≥digo de pa√≠s):</label>
                                        <input type="text" class="form-control" id="phone" placeholder="5491112345678" required>
                                        <small class="text-muted">Ejemplo: 5491112345678 (sin + ni espacios)</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Mensaje:</label>
                                        <textarea class="form-control" id="message" rows="4" required>¬°Hola! Este es un mensaje de prueba desde tu sistema de almac√©n üöÄ</textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">üì® Enviar Mensaje</button>
                                </form>
                                <div id="sendResult" class="mt-3"></div>
                            </div>

                            <!-- Informaci√≥n -->
                            <div class="tab-pane fade" id="info">
                                <h5>üîß Configuraci√≥n del Sistema:</h5>
                                <ul class="list-group">
                                    <li class="list-group-item"><strong>Evolution API:</strong> http://localhost:8080</li>
                                    <li class="list-group-item"><strong>API Key:</strong> <code>mi_clave_secreta_123</code></li>
                                    <li class="list-group-item"><strong>Instancia:</strong> almacen-whatsapp</li>
                                    <li class="list-group-item"><strong>Base de datos:</strong> PostgreSQL (Docker)</li>
                                </ul>

                                <h5 class="mt-4">üìã Endpoints Disponibles:</h5>
                                <ul class="list-group">
                                    <li class="list-group-item">
                                        <strong>Estado:</strong><br>
                                        <code>GET http://localhost:8080/instance/connectionState/almacen-whatsapp</code>
                                    </li>
                                    <li class="list-group-item">
                                        <strong>Enviar Mensaje:</strong><br>
                                        <code>POST http://localhost:8080/message/sendText/almacen-whatsapp</code>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'api/whatsapp-api.php';

        // Verificar estado al cargar
        checkStatus();
        setInterval(checkStatus, 5000);

        async function checkStatus() {
            try {
                const response = await fetch(`${API_URL}?action=status`);
                const result = await response.json();
                
                const status = document.getElementById('status');
                
                if (result.code === 200 && result.data && result.data.state === 'open') {
                    status.className = 'badge status-badge bg-success';
                    status.textContent = '‚úÖ Conectado';
                } else if (result.code === 200) {
                    status.className = 'badge status-badge bg-warning';
                    status.textContent = '‚è≥ Desconectado';
                } else if (result.code === 404) {
                    status.className = 'badge status-badge bg-info';
                    status.textContent = 'üì± Listo para conectar';
                } else {
                    status.className = 'badge status-badge bg-danger';
                    status.textContent = '‚ùå Error de API';
                }
            } catch (error) {
                document.getElementById('status').className = 'badge status-badge bg-secondary';
                document.getElementById('status').textContent = 'üîå Sin conexi√≥n';
            }
        }

        async function generateQR() {
            const qrcodeDiv = document.getElementById('qrcode');
            const instructions = document.getElementById('instructions');
            const btnGenerate = document.getElementById('btnGenerate');
            
            qrcodeDiv.innerHTML = '<div class="spinner-border text-success" role="status"></div><p>Generando QR...</p>';
            btnGenerate.disabled = true;

            try {
                // Crear instancia
                const response = await fetch(`${API_URL}?action=create`, { method: 'POST' });
                const text = await response.text();
                
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    throw new Error('Respuesta inv√°lida del servidor. Verifica que Apache y Evolution API est√©n corriendo.');
                }

                if (result.code === 200 || result.code === 201) {
                    const data = result.data;
                    
                    if (data.qrcode && data.qrcode.base64) {
                        qrcodeDiv.innerHTML = `<img src="${data.qrcode.base64}" alt="QR Code" class="img-fluid">`;
                        instructions.style.display = 'block';
                    } else if (data.qrcode && data.qrcode.code) {
                        qrcodeDiv.innerHTML = '<div class="alert alert-info">‚è≥ QR generado, obteniendo imagen...</div>';
                        setTimeout(getQRCode, 3000);
                    } else {
                        qrcodeDiv.innerHTML = '<div class="alert alert-info">‚è≥ Esperando QR Code...</div>';
                        setTimeout(getQRCode, 3000);
                    }
                } else if (result.code === 409) {
                    qrcodeDiv.innerHTML = '<div class="alert alert-info">Instancia ya existe, conectando...</div>';
                    setTimeout(getQRCode, 2000);
                } else {
                    const errorMsg = result.data?.message || result.data?.error || 'Error al crear instancia';
                    qrcodeDiv.innerHTML = `<div class="alert alert-danger">Error: ${errorMsg}</div>`;
                }
            } catch (error) {
                qrcodeDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${error.message}</div>`;
                console.error('Error completo:', error);
            } finally {
                btnGenerate.disabled = false;
            }
        }

        async function getQRCode() {
            try {
                const response = await fetch(`${API_URL}?action=connect`);
                const result = await response.json();

                if (result.code === 200 && result.data.qrcode && result.data.qrcode.base64) {
                    document.getElementById('qrcode').innerHTML = `<img src="${result.data.qrcode.base64}" alt="QR Code" class="img-fluid">`;
                    document.getElementById('instructions').style.display = 'block';
                }
            } catch (error) {
                console.error('Error obteniendo QR:', error);
            }
        }

        async function sendMessage(event) {
            event.preventDefault();
            
            const phone = document.getElementById('phone').value;
            const message = document.getElementById('message').value;
            const result = document.getElementById('sendResult');
            
            result.innerHTML = '<div class="alert alert-info">Enviando mensaje...</div>';

            try {
                const formData = new FormData();
                formData.append('action', 'send');
                formData.append('phone', phone);
                formData.append('message', message);

                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });

                const apiResult = await response.json();

                if (apiResult.code === 200 || apiResult.code === 201) {
                    result.innerHTML = '<div class="alert alert-success">‚úÖ Mensaje enviado exitosamente!</div>';
                } else {
                    result.innerHTML = `<div class="alert alert-danger">‚ùå Error: ${apiResult.data.message || apiResult.data.error || 'No se pudo enviar el mensaje'}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="alert alert-danger">‚ùå Error de conexi√≥n: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
