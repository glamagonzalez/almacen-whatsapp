{
  "name": "Sistema AlmacÃ©n WhatsApp - Flujo Completo",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "nuevo-pedido",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "Webhook - Nuevo Pedido",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "functionCode": "// Formatear mensaje de nuevo pedido\nconst pedido = $input.item.json;\n\nconst productosTexto = pedido.productos.map(p => \n  `â€¢ ${p.nombre} x${p.cantidad} = $${parseFloat(p.subtotal).toFixed(2)}`\n).join('\\n');\n\nconst mensaje = `ğŸ›’ *NUEVO PEDIDO #${pedido.pedido_id}*\\n\\n` +\n  `ğŸ‘¤ Cliente: ${pedido.cliente_nombre}\\n` +\n  `ğŸ“± TelÃ©fono: ${pedido.cliente_telefono}\\n` +\n  `ğŸ“§ Email: ${pedido.cliente_email}\\n` +\n  `ğŸ“ DirecciÃ³n: ${pedido.direccion}\\n\\n` +\n  `ğŸ“¦ *Productos:*\\n${productosTexto}\\n\\n` +\n  `ğŸ’° *TOTAL: $${parseFloat(pedido.total).toFixed(2)}*\\n\\n` +\n  `â³ Estado: Esperando pago Mercado Pago\\n` +\n  `ğŸ• Fecha: ${pedido.fecha}`;\n\nreturn [{\n  json: {\n    telefono: pedido.cliente_telefono,\n    mensaje: mensaje,\n    pedido_id: pedido.pedido_id\n  }\n}];"
      },
      "name": "Formatear Mensaje Cliente",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:8080/message/sendText",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{$json.telefono}}\",\n  \"text\": \"{{$json.mensaje}}\"\n}",
        "options": {}
      },
      "name": "Enviar WhatsApp Cliente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [650, 300]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "pago-confirmado",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "Webhook - Pago Confirmado",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 500]
    },
    {
      "parameters": {
        "functionCode": "// Mensaje de confirmaciÃ³n de pago\nconst pago = $input.item.json;\n\nconst mensaje = `âœ… *PAGO CONFIRMADO*\\n\\n` +\n  `Hola ${pago.cliente_nombre}! ğŸ‰\\n\\n` +\n  `ğŸ’³ Tu pago de $${parseFloat(pago.total).toFixed(2)} fue aprobado\\n` +\n  `ğŸ“ Pedido #${pago.pedido_id}\\n` +\n  `ğŸ†” Pago #${pago.mp_payment_id}\\n\\n` +\n  `ğŸšš Preparando tu pedido para envÃ­o...\\n` +\n  `ğŸ“¦ Te avisaremos cuando salga de nuestro depÃ³sito.\\n\\n` +\n  `Â¡Gracias por tu compra! ğŸ˜Š`;\n\nreturn [{\n  json: {\n    telefono: pago.cliente_telefono,\n    mensaje: mensaje,\n    pedido_id: pago.pedido_id\n  }\n}];"
      },
      "name": "Formatear ConfirmaciÃ³n Pago",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 500]
    },
    {
      "parameters": {
        "url": "http://localhost:8080/message/sendText",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{$json.telefono}}\",\n  \"text\": \"{{$json.mensaje}}\"\n}",
        "options": {}
      },
      "name": "Enviar WhatsApp ConfirmaciÃ³n",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [650, 500]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "pedido-enviado",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "Webhook - Pedido Enviado",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 700]
    },
    {
      "parameters": {
        "functionCode": "// Mensaje de envÃ­o\nconst envio = $input.item.json;\n\nconst tracking = envio.tracking ? `\\nğŸ”¢ Tracking: ${envio.tracking}` : '';\n\nconst mensaje = `ğŸšš *PEDIDO EN CAMINO*\\n\\n` +\n  `Hola ${envio.cliente_nombre}! ğŸ“¦\\n\\n` +\n  `âœ… Tu pedido #${envio.pedido_id} fue despachado${tracking}\\n\\n` +\n  `ğŸ“ DirecciÃ³n de entrega:\\n${envio.direccion}\\n\\n` +\n  `â° Tiempo estimado: 24-48 hs\\n\\n` +\n  `ğŸ“± Cualquier consulta, respondÃ© este mensaje.\\n\\n` +\n  `Â¡Gracias por confiar en nosotros! ğŸ™`;\n\nreturn [{\n  json: {\n    telefono: envio.cliente_telefono,\n    mensaje: mensaje\n  }\n}];"
      },
      "name": "Formatear Mensaje EnvÃ­o",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 700]
    },
    {
      "parameters": {
        "url": "http://localhost:8080/message/sendText",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{$json.telefono}}\",\n  \"text\": \"{{$json.mensaje}}\"\n}",
        "options": {}
      },
      "name": "Enviar WhatsApp EnvÃ­o",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [650, 700]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "stock-bajo",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "Webhook - Stock Bajo",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 900]
    },
    {
      "parameters": {
        "functionCode": "// Alerta de stock bajo al admin\nconst stock = $input.item.json;\n\nconst mensaje = `âš ï¸ *ALERTA DE STOCK BAJO*\\n\\n` +\n  `ğŸ“¦ Producto: ${stock.producto_nombre}\\n` +\n  `ğŸ“‚ CategorÃ­a: ${stock.categoria}\\n` +\n  `ğŸ“Š Stock actual: ${stock.stock_actual} unidades\\n` +\n  `ğŸ”´ Stock mÃ­nimo: ${stock.stock_minimo} unidades\\n\\n` +\n  `âš¡ AcciÃ³n requerida: Reabastecer producto`;\n\nreturn [{\n  json: {\n    telefono: \"5491112345678\", // TU NÃšMERO DE ADMIN\n    mensaje: mensaje\n  }\n}];"
      },
      "name": "Formatear Alerta Stock",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [450, 900]
    },
    {
      "parameters": {
        "url": "http://localhost:8080/message/sendText",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{$json.telefono}}\",\n  \"text\": \"{{$json.mensaje}}\"\n}",
        "options": {}
      },
      "name": "Enviar WhatsApp Admin",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [650, 900]
    }
  ],
  "connections": {
    "Webhook - Nuevo Pedido": {
      "main": [[{"node": "Formatear Mensaje Cliente", "type": "main", "index": 0}]]
    },
    "Formatear Mensaje Cliente": {
      "main": [[{"node": "Enviar WhatsApp Cliente", "type": "main", "index": 0}]]
    },
    "Webhook - Pago Confirmado": {
      "main": [[{"node": "Formatear ConfirmaciÃ³n Pago", "type": "main", "index": 0}]]
    },
    "Formatear ConfirmaciÃ³n Pago": {
      "main": [[{"node": "Enviar WhatsApp ConfirmaciÃ³n", "type": "main", "index": 0}]]
    },
    "Webhook - Pedido Enviado": {
      "main": [[{"node": "Formatear Mensaje EnvÃ­o", "type": "main", "index": 0}]]
    },
    "Formatear Mensaje EnvÃ­o": {
      "main": [[{"node": "Enviar WhatsApp EnvÃ­o", "type": "main", "index": 0}]]
    },
    "Webhook - Stock Bajo": {
      "main": [[{"node": "Formatear Alerta Stock", "type": "main", "index": 0}]]
    },
    "Formatear Alerta Stock": {
      "main": [[{"node": "Enviar WhatsApp Admin", "type": "main", "index": 0}]]
    }
  }
}
